name: Renovate Configuration Validation

on:
  push:
    branches-ignore:
      - main
    paths:
      - renovate.json
      - default.json
      - renovate-presets/**

jobs:
  detect-modified-renovate-configs:
    name: Detect modified Renovate configuration files
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.changed-renovate-configs.outputs.all_changed_files }}
    steps:
      - uses: actions/checkout@v4

      - name: Get changed renovate configs
        id: changed-renovate-configs
        uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62 # v47
        with:
          files: |
            renovate.json
            default.json
            renovate-presets/**"
          matrix: true

  validate-renovate-configs:
    name: Validate Renovate Configs
    runs-on: ubuntu-latest
    needs: [detect-modified-renovate-configs]
    strategy:
      matrix: 
        config: ${{ fromJSON(needs.detect-modified-renovate-configs.outputs.matrix) }}
      max-parallel: 4
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install renovate
        run: npm install -g renovate

      - name: Validate configuration "${{ matrix.config }}"
        run: renovate-config-validator ${{ matrix.config }}

  collect-validation-results:
    name: Renovate validation results collector
    needs: [validate-renovate-configs]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: All renovate config validation jobs passed
        id: renovate-validation-passed
        run: echo "All renovate config validation jobs passed!"

