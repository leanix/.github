name: Renovate Configuration Validation

on:
  push:
    branches-ignore:
      - main

jobs:
  detect-modified-renovate-configs:
    name: Detect modified Renovate configuration files
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.changed-renovate-configs.outputs.all_changed_files }}
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6

      - name: Get changed renovate configs
        id: changed-renovate-configs
        uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62 # v47
        with:
          files: |
            renovate.json
            default.json
            renovate-presets/**
          matrix: true

  validate-renovate-configs:
    name: Validate Renovate Configs
    runs-on: ubuntu-latest
    needs: [detect-modified-renovate-configs]
    if: ${{ needs.detect-modified-renovate-configs.outputs.matrix != '[]' }}
    strategy:
      matrix: 
        config: ${{ fromJSON(needs.detect-modified-renovate-configs.outputs.matrix) }}
      max-parallel: 4
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6
        with:
          node-version: '24.11.1'

      - name: Install renovate
        run: npm install -g renovate

      - name: Validate configuration "${{ matrix.config }}"
        run: renovate-config-validator ${{ matrix.config }}

  collect-validation-results:
    # This job must always run and report a status since it is a required status check
    name: Renovate validation results collector
    needs: 
        - detect-modified-renovate-configs
        - validate-renovate-configs
    runs-on: ubuntu-latest
    if: always() && !cancelled()
    steps:
      - name: All renovate config validation jobs passed
        id: renovate-validation-passed
        run: |
          if [ "${{ needs.detect-modified-renovate-configs.outputs.matrix }}" == "[]" ]; then
            echo "No renovate configuration changed"
          elif [ "${{ needs.validate-renovate-configs.result }}" == "success" ]; then
            echo "All renovate config validation jobs passed!"
          else
            echo "Renovate config validation failed!"
            exit 1
          fi

